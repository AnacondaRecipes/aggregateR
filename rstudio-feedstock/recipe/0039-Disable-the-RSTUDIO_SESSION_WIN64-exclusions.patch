From f4aa156fe262bd329f686ce5fe03954e1d23fe5a Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Mon, 26 Mar 2018 10:24:28 -0700
Subject: [PATCH 39/42] Disable the RSTUDIO_SESSION_WIN64 exclusions

.. and also the x64 vs bin install layout changes.
---
 CMakeGlobals.txt                        | 2 +-
 src/cpp/desktop/CMakeLists.txt          | 2 +-
 src/cpp/desktop/DesktopMain.cpp         | 4 ++--
 src/cpp/diagnostics/CMakeLists.txt      | 2 +-
 src/cpp/r/CMakeLists.txt                | 2 +-
 src/cpp/session/CMakeLists.txt          | 6 +++---
 src/cpp/session/postback/CMakeLists.txt | 2 +-
 7 files changed, 10 insertions(+), 10 deletions(-)

diff --git a/CMakeGlobals.txt b/CMakeGlobals.txt
index a70d9062e0..ac05c54925 100644
--- a/CMakeGlobals.txt
+++ b/CMakeGlobals.txt
@@ -149,7 +149,7 @@ if (APPLE AND RSTUDIO_DESKTOP AND NOT DEFINED ENV{CONDA_BUILD})
    set(RSTUDIO_INSTALL_BIN RStudio.app/Contents/MacOS)
    set(RSTUDIO_INSTALL_SUPPORTING RStudio.app/Contents/Resources)
 else()
-   if (RSTUDIO_SESSION_WIN64)
+   if (RSTUDIO_SESSION_WIN64 AND NOT DEFINED ENV{CONDA_BUILD})
      set(RSTUDIO_INSTALL_BIN x64)
    else()
      set(RSTUDIO_INSTALL_BIN bin)
diff --git a/src/cpp/desktop/CMakeLists.txt b/src/cpp/desktop/CMakeLists.txt
index 50e7aa913f..a8d0c37a6a 100644
--- a/src/cpp/desktop/CMakeLists.txt
+++ b/src/cpp/desktop/CMakeLists.txt
@@ -296,7 +296,7 @@ if(WIN32)
    configure_file (${CMAKE_CURRENT_SOURCE_DIR}/rstudio.exe.manifest
                    ${CMAKE_CURRENT_BINARY_DIR}/rstudio.exe.manifest COPYONLY)
 
-   if(NOT RSTUDIO_SESSION_WIN64)
+   if(NOT RSTUDIO_SESSION_WIN64 OR DEFINED ENV{CONDA_BUILD}))
       add_subdirectory(urlopener)
       add_subdirectory(synctex/rsinverse)
    endif()
diff --git a/src/cpp/desktop/DesktopMain.cpp b/src/cpp/desktop/DesktopMain.cpp
index 1727c65d23..ddae69aa61 100644
--- a/src/cpp/desktop/DesktopMain.cpp
+++ b/src/cpp/desktop/DesktopMain.cpp
@@ -463,7 +463,7 @@ int main(int argc, char* argv[])
          sessionPath = currentPath.complete("session/rsession");
          scriptsPath = currentPath.complete("desktop");
          devMode = true;
-#ifdef _WIN32
+#if defined(_WIN32) && !defined(CONDA_BUILD)
          if (version.architecture() == ArchX64 &&
              installPath.complete("session/x64").exists())
          {
@@ -480,7 +480,7 @@ int main(int argc, char* argv[])
          scriptsPath = installPath.complete("bin");
 
          // check for win64 binary on windows
-#ifdef _WIN32
+#if defined(_WIN32) && !defined(CONDA_BUILD)
          if (version.architecture() == ArchX64 &&
              installPath.complete("bin/x64").exists())
          {
diff --git a/src/cpp/diagnostics/CMakeLists.txt b/src/cpp/diagnostics/CMakeLists.txt
index 9b45573de4..9f11340fb4 100644
--- a/src/cpp/diagnostics/CMakeLists.txt
+++ b/src/cpp/diagnostics/CMakeLists.txt
@@ -63,7 +63,7 @@ endif()
 target_link_libraries(diagnostics
    rstudio-core
 )
-if(NOT RSTUDIO_SESSION_WIN64)
+if(NOT RSTUDIO_SESSION_WIN64 OR DEFINED ENV{CONDA_BUILD}))
    install(TARGETS diagnostics DESTINATION ${RSTUDIO_INSTALL_BIN})
 endif()
 
diff --git a/src/cpp/r/CMakeLists.txt b/src/cpp/r/CMakeLists.txt
index f6a66c453b..9fac52a82c 100644
--- a/src/cpp/r/CMakeLists.txt
+++ b/src/cpp/r/CMakeLists.txt
@@ -96,7 +96,7 @@ target_link_libraries(rstudio-r
 )
 
 # install rules
-if (NOT RSTUDIO_SESSION_WIN64)
+if (NOT RSTUDIO_SESSION_WIN64 OR DEFINED ENV{CONDA_BUILD})
    file(GLOB R_SRC_FILES "R/*.R")
    install(FILES ${R_SRC_FILES} DESTINATION ${RSTUDIO_INSTALL_SUPPORTING}/R)
 endif()
diff --git a/src/cpp/session/CMakeLists.txt b/src/cpp/session/CMakeLists.txt
index 0b89447bbe..5d81089ec8 100644
--- a/src/cpp/session/CMakeLists.txt
+++ b/src/cpp/session/CMakeLists.txt
@@ -344,7 +344,7 @@ if(WIN32)
    configure_file (${CMAKE_CURRENT_SOURCE_DIR}/rsession.exe.manifest
                    ${CMAKE_CURRENT_BINARY_DIR}/rsession.exe.manifest COPYONLY)
 
-   if(NOT RSTUDIO_SESSION_WIN64)
+   if(NOT RSTUDIO_SESSION_WIN64 OR DEFINED ENV{CONDA_BUILD})
       add_subdirectory(consoleio)
    endif()
 endif()
@@ -428,7 +428,7 @@ endif()
 install(TARGETS rsession DESTINATION ${RSTUDIO_INSTALL_BIN})
 
 # include resources, R scripts and 64bit binaries if this isn't a session 64bit build
-if (NOT RSTUDIO_SESSION_WIN64)
+if (NOT RSTUDIO_SESSION_WIN64 OR DEFINED ENV{CONDA_BUILD})
 
    # postback
    add_subdirectory(postback)
@@ -585,7 +585,7 @@ if (NOT RSTUDIO_SESSION_WIN64)
 endif()
 
 # install 64-bit MSVC runtime for session win64
-if(RSTUDIO_SESSION_WIN64)
+if(RSTUDIO_SESSION_WIN64 AND NOT DEFINED ENV{CONDA_BUILD})
    include(InstallRequiredSystemLibraries)
    install(FILES ${CMAKE_INSTALL_SYSTEM_RUNTIME_LIBS} DESTINATION ${RSTUDIO_INSTALL_BIN})
 endif()
diff --git a/src/cpp/session/postback/CMakeLists.txt b/src/cpp/session/postback/CMakeLists.txt
index 1ee77b75ee..b4cd926b46 100644
--- a/src/cpp/session/postback/CMakeLists.txt
+++ b/src/cpp/session/postback/CMakeLists.txt
@@ -55,7 +55,7 @@ configure_file(rpostback-askpass ${POSTBACK_SCRIPT_DIR}/rpostback-askpass)
 configure_file(askpass-passthrough ${POSTBACK_SCRIPT_DIR}/askpass-passthrough)
 
 # installation rules
-if(NOT RSTUDIO_SESSION_WIN64)
+if(NOT RSTUDIO_SESSION_WIN64 OR DEFINED ENV{CONDA_BUILD})
    install(TARGETS rpostback DESTINATION ${RSTUDIO_INSTALL_BIN})
    file(GLOB POSTBACK_SCRIPTS "rpostback-*")
    set(POSTBACK_SCRIPTS ${POSTBACK_SCRIPTS} "askpass-passthrough")
-- 
2.16.2

