From 0f06fcc9a7da79fe59468bfffc01ae8722050688 Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Mon, 31 Oct 2016 11:56:29 +0000
Subject: [PATCH 16/33] Conda: Define CONDA_BUILD when ENV{CONDA_BUILD} for
 rstudio and rsession

A subsequent commit will check this and put all resources under a
`share/rstudio/` folder instead of `resources/`
---
 src/cpp/core/CMakeLists.txt        | 4 ++++
 src/cpp/desktop-mac/CMakeLists.txt | 2 ++
 src/cpp/desktop/CMakeLists.txt     | 4 ++++
 src/cpp/session/CMakeLists.txt     | 4 ++++
 4 files changed, 14 insertions(+)

diff --git a/src/cpp/core/CMakeLists.txt b/src/cpp/core/CMakeLists.txt
index 98301db99d..2a65480539 100644
--- a/src/cpp/core/CMakeLists.txt
+++ b/src/cpp/core/CMakeLists.txt
@@ -344,6 +344,10 @@ target_link_libraries(
    ${CORE_SYSTEM_LIBRARIES}
 )
 
+if(DEFINED ENV{CONDA_BUILD})
+   target_compile_definitions(rstudio-core PRIVATE "-DCONDA_BUILD")
+endif()
+
 # define executable (for running unit tests)
 if (RSTUDIO_UNIT_TESTS_ENABLED)
 
diff --git a/src/cpp/desktop-mac/CMakeLists.txt b/src/cpp/desktop-mac/CMakeLists.txt
index 58fbfb49bc..d59ddfa779 100644
--- a/src/cpp/desktop-mac/CMakeLists.txt
+++ b/src/cpp/desktop-mac/CMakeLists.txt
@@ -106,6 +106,8 @@ else()
       ${OPENGL_LIBRARY}
       ${WEBKIT_LIBRARY})
 
+   target_compile_definitions(rstudio PRIVATE "-DCONDA_BUILD")
+
    # install target
    install(TARGETS rstudio DESTINATION ${RSTUDIO_INSTALL_BIN})
 
diff --git a/src/cpp/desktop/CMakeLists.txt b/src/cpp/desktop/CMakeLists.txt
index 8fda3efe5c..3bdfaf93d2 100644
--- a/src/cpp/desktop/CMakeLists.txt
+++ b/src/cpp/desktop/CMakeLists.txt
@@ -378,6 +378,10 @@ if(NOT APPLE OR DEFINED ENV{CONDA_BUILD})
       target_link_libraries(rstudio Version)
    endif()
 
+   if(DEFINED ENV{CONDA_BUILD})
+      target_compile_definitions(rstudio PRIVATE "-DCONDA_BUILD")
+   endif()
+
    # install target
    install(TARGETS rstudio DESTINATION ${RSTUDIO_INSTALL_BIN})
 
diff --git a/src/cpp/session/CMakeLists.txt b/src/cpp/session/CMakeLists.txt
index 4c979dcbc7..251f399e95 100644
--- a/src/cpp/session/CMakeLists.txt
+++ b/src/cpp/session/CMakeLists.txt
@@ -357,6 +357,10 @@ if(RSTUDIO_DEVELOPMENT OR RSTUDIO_RUN_IN_PLACE)
    set_target_properties(rsession PROPERTIES SKIP_BUILD_RPATH TRUE)
 endif()
 
+if(DEFINED ENV{CONDA_BUILD})
+   target_compile_definitions(rsession PRIVATE "-DCONDA_BUILD")
+endif()
+
 # add origin rpath for suse/sles
 if(RSTUDIO_PACKAGE_VARIANT STREQUAL "SLES")
    set(CMAKE_BUILD_WITH_INSTALL_RPATH TRUE)
-- 
2.14.3 (Apple Git-98)

