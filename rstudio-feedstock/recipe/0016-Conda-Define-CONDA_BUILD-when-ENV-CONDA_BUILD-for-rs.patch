From e8e7478a76800d0517b28aaf79a182bfb0323164 Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Mon, 31 Oct 2016 11:56:29 +0000
Subject: [PATCH 16/35] Conda: Define CONDA_BUILD when ENV{CONDA_BUILD} for
 rstudio and rsession

A subsequent commit will check this and put all resources under a
`share/rstudio/` folder instead of `resources/`
---
 src/cpp/core/CMakeLists.txt        |  4 ++++
 src/cpp/desktop-mac/CMakeLists.txt |  2 ++
 src/cpp/desktop/CMakeLists.txt     | 40 ++++++++++++++++++++++++--------------
 src/cpp/session/CMakeLists.txt     |  4 ++++
 4 files changed, 35 insertions(+), 15 deletions(-)

diff --git a/src/cpp/core/CMakeLists.txt b/src/cpp/core/CMakeLists.txt
index 98301db99d..2a65480539 100644
--- a/src/cpp/core/CMakeLists.txt
+++ b/src/cpp/core/CMakeLists.txt
@@ -344,6 +344,10 @@ target_link_libraries(
    ${CORE_SYSTEM_LIBRARIES}
 )
 
+if(DEFINED ENV{CONDA_BUILD})
+   target_compile_definitions(rstudio-core PRIVATE "-DCONDA_BUILD")
+endif()
+
 # define executable (for running unit tests)
 if (RSTUDIO_UNIT_TESTS_ENABLED)
 
diff --git a/src/cpp/desktop-mac/CMakeLists.txt b/src/cpp/desktop-mac/CMakeLists.txt
index 58fbfb49bc..d59ddfa779 100644
--- a/src/cpp/desktop-mac/CMakeLists.txt
+++ b/src/cpp/desktop-mac/CMakeLists.txt
@@ -106,6 +106,8 @@ else()
       ${OPENGL_LIBRARY}
       ${WEBKIT_LIBRARY})
 
+   target_compile_definitions(rstudio PRIVATE "-DCONDA_BUILD")
+
    # install target
    install(TARGETS rstudio DESTINATION ${RSTUDIO_INSTALL_BIN})
 
diff --git a/src/cpp/desktop/CMakeLists.txt b/src/cpp/desktop/CMakeLists.txt
index 8fda3efe5c..3c26809a7e 100644
--- a/src/cpp/desktop/CMakeLists.txt
+++ b/src/cpp/desktop/CMakeLists.txt
@@ -335,10 +335,16 @@ set(RSTUDIO_QTMODULES
     Qml
 )
 
+if(APPLE)
+   set(RSTUDIO_EXE_NAME "RStudio")
+else()
+   set(RSTUDIO_EXE_NAME "rstudio")
+endif(APPLE)
+
 # define executable (Windows & Linux)
 if(NOT APPLE OR DEFINED ENV{CONDA_BUILD})
 
-   add_executable(rstudio
+   add_executable(${RSTUDIO_EXE_NAME}
       ${DESKTOP_SOURCE_FILES}
       ${MOC_DESKTOP_SOURCE_FILES}
       ${DESKTOP_RESOURCES_SOURCES}
@@ -353,20 +359,20 @@ if(NOT APPLE OR DEFINED ENV{CONDA_BUILD})
    )
 
    if(WIN32)
-      qt5_use_modules(rstudio ${RSTUDIO_QTMODULES} ${RSTUDIO_EXTRA_QTMODULES})
+      qt5_use_modules(${RSTUDIO_EXE_NAME} ${RSTUDIO_QTMODULES} ${RSTUDIO_EXTRA_QTMODULES})
    else()
-      qt5_use_modules(rstudio ${RSTUDIO_QTMODULES} ${RSTUDIO_EXTRA_QTMODULES} DBus)
+      qt5_use_modules(${RSTUDIO_EXE_NAME} ${RSTUDIO_QTMODULES} ${RSTUDIO_EXTRA_QTMODULES} DBus)
    endif()
 
    # add rpath for linux so we can find qt libraries in our bin dir
    if(UNIX AND RSTUDIO_BUNDLE_QT)
       set(CMAKE_BUILD_WITH_INSTALL_RPATH TRUE)
-      set_target_properties(rstudio PROPERTIES
+      set_target_properties(${RSTUDIO_EXE_NAME} PROPERTIES
                             INSTALL_RPATH \$ORIGIN)
    endif()
 
    # set link dependencies
-   target_link_libraries(rstudio
+   target_link_libraries(${RSTUDIO_EXE_NAME}
       ${QT_LIBRARIES}
       ${Boost_LIBRARIES}
       rstudio-core
@@ -375,11 +381,15 @@ if(NOT APPLE OR DEFINED ENV{CONDA_BUILD})
 
    # extra dependencies for Windows
    if(WIN32)
-      target_link_libraries(rstudio Version)
+      target_link_libraries(${RSTUDIO_EXE_NAME} Version)
+   endif()
+
+   if(DEFINED ENV{CONDA_BUILD})
+      target_compile_definitions(${RSTUDIO_EXE_NAME} PRIVATE "-DCONDA_BUILD")
    endif()
 
    # install target
-   install(TARGETS rstudio DESTINATION ${RSTUDIO_INSTALL_BIN})
+   install(TARGETS ${RSTUDIO_EXE_NAME} DESTINATION ${RSTUDIO_INSTALL_BIN})
 
 # for OSX we create a bundle
 elseif(APPLE)
@@ -402,7 +412,7 @@ elseif(APPLE)
    # define bundle name and executable
    set(MACOSX_BUNDLE_BUNDLE_NAME "RStudio")
 
-   add_executable(RStudio MACOSX_BUNDLE
+   add_executable(${RSTUDIO_EXE_NAME} MACOSX_BUNDLE
       ${DESKTOP_SOURCE_FILES}
       ${MOC_DESKTOP_SOURCE_FILES}
       ${DESKTOP_RESOURCES_SOURCES}
@@ -410,9 +420,9 @@ elseif(APPLE)
       ${ICNS_FILES}
       ${PNG_FILES})
 
-   qt5_use_modules(RStudio ${RSTUDIO_QTMODULES})
+   qt5_use_modules(${RSTUDIO_EXE_NAME} ${RSTUDIO_QTMODULES})
 
-   target_link_libraries(RStudio
+   target_link_libraries(${RSTUDIO_EXE_NAME}
       ${QT_LIBRARIES}
       rstudio-core
       ${APPLICATION_SERVICES_LIBRARY}
@@ -422,12 +432,12 @@ elseif(APPLE)
 endif()
 
 # install target (OSX install goes into the bundle)
-if(APPLE)
-  set_target_properties(RStudio PROPERTIES
+if(APPLE AND NOT DEFINED ENV{CONDA_BUILD})
+  set_target_properties(${RSTUDIO_EXE_NAME} PROPERTIES
      MACOSX_BUNDLE_INFO_PLIST ${CMAKE_CURRENT_BINARY_DIR}/Info.plist)
-  install(TARGETS RStudio BUNDLE DESTINATION .)
+  install(TARGETS ${RSTUDIO_EXE_NAME} BUNDLE DESTINATION .)
 else()
-  install(TARGETS rstudio DESTINATION ${RSTUDIO_INSTALL_BIN})
+  install(TARGETS ${RSTUDIO_EXE_NAME} DESTINATION ${RSTUDIO_INSTALL_BIN})
 endif()
 
 # bundle qt dependencies if this is a package build
@@ -519,7 +529,7 @@ if(RSTUDIO_BUNDLE_QT)
          add_library(${ICU_LIBRARY} SHARED IMPORTED)
          set_property(TARGET ${ICU_LIBRARY} PROPERTY IMPORTED_LOCATION "${QT_LIBRARY_DIR}/${ICU_LIBRARY}.so")
       endforeach()
-      target_link_libraries(rstudio ${ICU_LIBRARIES})
+      target_link_libraries(${RSTUDIO_EXE_NAME} ${ICU_LIBRARIES})
 
       # configure and install qt
       configure_file(
diff --git a/src/cpp/session/CMakeLists.txt b/src/cpp/session/CMakeLists.txt
index 4c979dcbc7..251f399e95 100644
--- a/src/cpp/session/CMakeLists.txt
+++ b/src/cpp/session/CMakeLists.txt
@@ -357,6 +357,10 @@ if(RSTUDIO_DEVELOPMENT OR RSTUDIO_RUN_IN_PLACE)
    set_target_properties(rsession PROPERTIES SKIP_BUILD_RPATH TRUE)
 endif()
 
+if(DEFINED ENV{CONDA_BUILD})
+   target_compile_definitions(rsession PRIVATE "-DCONDA_BUILD")
+endif()
+
 # add origin rpath for suse/sles
 if(RSTUDIO_PACKAGE_VARIANT STREQUAL "SLES")
    set(CMAKE_BUILD_WITH_INSTALL_RPATH TRUE)
-- 
2.14.3 (Apple Git-98)

