From bb5e3813d9c57ecfc64c3413c419732fe1cb0084 Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Sat, 4 Feb 2017 13:29:12 -0500
Subject: [PATCH 23/42] Use conda's pandoc when CONDA_BUILD

---
 dependencies/windows/install-dependencies.cmd | 18 ++++++++++--------
 src/cpp/session/CMakeLists.txt                |  2 +-
 src/cpp/session/SessionOptions.cpp            |  6 +++++-
 3 files changed, 16 insertions(+), 10 deletions(-)

diff --git a/dependencies/windows/install-dependencies.cmd b/dependencies/windows/install-dependencies.cmd
index fa8494947d..2787b8b08c 100644
--- a/dependencies/windows/install-dependencies.cmd
+++ b/dependencies/windows/install-dependencies.cmd
@@ -186,14 +186,16 @@ if not exist "mathjax-26" (
   )
 )
 
-if not exist pandoc\%PANDOC_VERSION% (
-  wget %WGET_ARGS% "%BASEURL%%PANDOC_FILE%"
-  echo Unzipping %PANDOC_FILE%
-  unzip %UNZIP_ARGS% "%PANDOC_FILE%"
-  mkdir pandoc\%PANDOC_VERSION%
-  copy "%PANDOC_NAME%\windows\pandoc*" "pandoc\%PANDOC_VERSION%""
-  del %PANDOC_FILE%
-  rmdir /s /q %PANDOC_NAME%
+if not "%CONDA_BUILD%" == "1" (
+  if not exist pandoc\%PANDOC_VERSION% (
+    wget %WGET_ARGS% "%BASEURL%%PANDOC_FILE%"
+    echo Unzipping %PANDOC_FILE%
+    unzip %UNZIP_ARGS% "%PANDOC_FILE%"
+    mkdir pandoc\%PANDOC_VERSION%
+    copy "%PANDOC_NAME%\windows\pandoc*" "pandoc\%PANDOC_VERSION%""
+    del %PANDOC_FILE%
+    rmdir /s /q %PANDOC_NAME%
+  )
 )
 
 if not exist libclang\%LIBCLANG_VERSION% (
diff --git a/src/cpp/session/CMakeLists.txt b/src/cpp/session/CMakeLists.txt
index d4991d2628..0b89447bbe 100644
--- a/src/cpp/session/CMakeLists.txt
+++ b/src/cpp/session/CMakeLists.txt
@@ -25,7 +25,7 @@ endif()
 if(NOT EXISTS "${RSTUDIO_DEPENDENCIES_DIR}/common/mathjax-26")
   message(FATAL_ERROR "Mathjax 2.6 not found (re-run install-dependencies script to install)")
 endif()
-if(NOT EXISTS "${RSTUDIO_DEPENDENCIES_DIR}/common/pandoc")
+if(NOT DEFINED ENV{CONDA_BUILD} AND NOT EXISTS "${RSTUDIO_DEPENDENCIES_DIR}/common/pandoc")
   message(FATAL_ERROR "pandoc not found (re-run install-dependencies script to install)")
 endif()
 
diff --git a/src/cpp/session/SessionOptions.cpp b/src/cpp/session/SessionOptions.cpp
index 25dba91512..35d9a3bbfc 100644
--- a/src/cpp/session/SessionOptions.cpp
+++ b/src/cpp/session/SessionOptions.cpp
@@ -77,7 +77,11 @@ const char* const kDefaultMsysSshPath = "bin/msys-ssh-1000-18";
 // resources directory so this gets us to prefix/bin
 // For gnudiff, gnugrep and msysssh we use conda's
 // m2w64-diffutils, m2w64-grep and m2-openssh respectively.
-const char* const kDefaultPandocPath = "../../bin/pandoc";
+#ifdef _WIN32
+   const char* const kDefaultPandocPath = "../../Scripts/pandoc";
+#else
+   const char* const kDefaultPandocPath = "../../bin/pandoc";
+#endif
 const char* const kDefaultPostbackPath = "../../bin/rpostback";
 const char* const kDefaultDiagnosticsPath = "../../bin/diagnostics";
 const char* const kDefaultConsoleIoPath = "../../bin/consoleio";
-- 
2.15.1 (Apple Git-101)

