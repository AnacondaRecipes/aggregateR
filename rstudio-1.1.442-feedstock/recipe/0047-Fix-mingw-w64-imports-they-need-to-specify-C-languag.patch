From 0a647f5b53eb70fc8eb52454864a9c958dfbdddb Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Tue, 21 Aug 2018 16:44:49 -0500
Subject: [PATCH 47/47] Fix mingw-w64 imports, they need to specify C language

---
 src/cpp/r/RExec.cpp                          | 8 ++++----
 src/cpp/r/include/r/RInterface.hpp           | 3 +--
 src/cpp/r/session/REmbeddedWin32.cpp         | 1 +
 src/cpp/r/session/RSession.cpp               | 2 +-
 src/cpp/session/modules/SessionWorkbench.cpp | 2 +-
 5 files changed, 8 insertions(+), 8 deletions(-)

diff --git a/src/cpp/r/RExec.cpp b/src/cpp/r/RExec.cpp
index ff8f584715..01ab72baf1 100644
--- a/src/cpp/r/RExec.cpp
+++ b/src/cpp/r/RExec.cpp
@@ -27,11 +27,11 @@
 
 #include <R_ext/Parse.h>
 
-#include <R_ext/libextern.h> 
-LibExtern Rboolean R_interrupts_suspended;
-LibExtern int R_interrupts_pending;
+#include <R_ext/libextern.h>
+extern "C" __declspec(dllimport) Rboolean R_interrupts_suspended;
+extern "C" __declspec(dllimport) int R_interrupts_pending;
 #ifdef _WIN32
-LibExtern int UserBreak;
+extern "C" __declspec(dllimport) int UserBreak;
 #endif
 
 using namespace rstudio::core ;
diff --git a/src/cpp/r/include/r/RInterface.hpp b/src/cpp/r/include/r/RInterface.hpp
index 153fc4e5ed..0350f6faa5 100644
--- a/src/cpp/r/include/r/RInterface.hpp
+++ b/src/cpp/r/include/r/RInterface.hpp
@@ -30,13 +30,12 @@ extern "C" LibExtern void R_SaveGlobalEnvToFile(const char *);
 extern "C" LibExtern void R_Suicide(const char *);
 extern "C" LibExtern char *R_HomeDir(void);
 extern "C" void Rf_jump_to_toplevel(void);
-extern "C" LibExtern void Rf_onintr(void);
 #define R_ClearerrConsole void
 extern "C" LibExtern void R_FlushConsole();
 extern "C" LibExtern int R_SignalHandlers;
 extern "C" LibExtern void run_Rmainloop();
 extern "C" void Rf_mainloop(void);
-extern "C" void* R_GlobalContext;
+extern "C" LibExtern void* R_GlobalContext;
 
 typedef struct SEXPREC *SEXP;
 
diff --git a/src/cpp/r/session/REmbeddedWin32.cpp b/src/cpp/r/session/REmbeddedWin32.cpp
index 54bce33181..38382a5a73 100644
--- a/src/cpp/r/session/REmbeddedWin32.cpp
+++ b/src/cpp/r/session/REmbeddedWin32.cpp
@@ -95,6 +95,7 @@ int askYesNoCancel(const char* question)
    case IDNO:
       return NO;
    case IDCANCEL:
+   default:
       return CANCEL;
    }
 }
diff --git a/src/cpp/r/session/RSession.cpp b/src/cpp/r/session/RSession.cpp
index dcbd554cb8..8fecd20c8a 100644
--- a/src/cpp/r/session/RSession.cpp
+++ b/src/cpp/r/session/RSession.cpp
@@ -62,7 +62,7 @@
 #include <R_ext/Utils.h>
 #include <R_ext/Rdynload.h>
 #include <R_ext/RStartup.h>
-extern "C" SA_TYPE SaveAction;
+extern "C" __declspec(dllimport) SA_TYPE SaveAction;
 
 #define CTXT_BROWSER 16
 
diff --git a/src/cpp/session/modules/SessionWorkbench.cpp b/src/cpp/session/modules/SessionWorkbench.cpp
index f2ef2a8bad..a44371122a 100644
--- a/src/cpp/session/modules/SessionWorkbench.cpp
+++ b/src/cpp/session/modules/SessionWorkbench.cpp
@@ -50,7 +50,7 @@
 #include "SessionSpelling.hpp"
 
 #include <R_ext/RStartup.h>
-extern "C" SA_TYPE SaveAction;
+extern "C" __declspec(dllimport) SA_TYPE SaveAction;
 
 #include "session-config.h"
 #ifdef RSTUDIO_SERVER
-- 
2.17.0.windows.1

